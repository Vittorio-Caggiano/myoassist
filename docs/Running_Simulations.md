# Running a Simulation

This document explains how to use the `sample_run.ipynb` Jupyter notebook to load a neuromuscular reflex model, configure a simulation environment, and render a video of the resulting locomotion.

## Overview

The `sample_run.ipynb` notebook provides a straightforward way to visualize the performance of a controller. It offers two primary modes of operation:
1.  **Loading from Optimization Results**: Load a set of optimized controller parameters from a file generated by an optimization run.
2.  **Manual Configuration**: Manually define all simulation parameters, such as the musculoskeletal model, exoskeleton settings, and terrain slope.

## Configuration

The second cell of the notebook contains all the necessary configuration settings.

```python
# --- Load from Optimization Results ---
LOAD_FROM_FILE = False
PARAMS_FILE_PATH = "path/to/your/parameters.txt" # Example Path

# --- Manual Configuration Settings ---
SIMULATION_TIME = 5      # seconds
SLOPE_DEG = 0             # env slope degrees
MODEL = "baseline"           # Options: dephy, hmedi, humotech, osl, baseline
EXO_BOOL = False           # Enable or disable exoskeleton
USE_4PARAM_SPLINE = False # Use 4-parameter spline for exoskeleton
N_POINTS = 4              # Number of points for n-point spline
MAX_TORQUE = 100          # Maximum exoskeleton torque
CONSTANT_HEIGHT_CAMERA = False # Keep camera at a fixed height
```

### Method 1: Loading from Optimization Results

To visualize a controller that you have already optimized, set `LOAD_FROM_FILE` to `True` and provide the path to your results file.

1.  **`LOAD_FROM_FILE = True`**: This tells the script to ignore the manual settings and instead load a saved configuration.
2.  **`PARAMS_FILE_PATH`**: Set this to the path of the `_Best.txt` or `_BestLast.txt` file generated by an optimization run. The script will automatically locate the corresponding `.bat` file in the same directory to reconstruct the full environment.

### Method 2: Manual Configuration

To create a new simulation from scratch, set `LOAD_FROM_FILE` to `False` and adjust the manual parameters as needed. This is useful for testing new ideas or observing the behavior of the default (un-optimized) controller.

-   `SIMULATION_TIME`: The duration of the simulation in seconds.
-   `SLOPE_DEG`: The angle of the terrain in degrees. Use positive values for uphill and negative for downhill.
-   `MODEL`: The musculoskeletal model to use. Options include: `"baseline"`, `"dephy"`, `"hmedi"`, `"humotech"`, and `"osl"`.
-   `EXO_BOOL`: A boolean (`True`/`False`) to enable or disable the exoskeleton.
-   `USE_4PARAM_SPLINE`: If `EXO_BOOL` is `True`, this determines the type of spline controller for the exoskeleton. `True` for the 4-parameter spline, `False` for the n-point spline.
-   `N_POINTS`: If using the n-point spline, this sets the number of control points.
-   `MAX_TORQUE`: The maximum torque output of the exoskeleton.
-   `CONSTANT_HEIGHT_CAMERA`: A boolean to control camera behavior on slopes. If `True`, the camera maintains a fixed height relative to the world origin. If `False`, it follows the vertical elevation of the slope.

## Environment Initialization

The third cell handles the creation of the simulation environment based on your chosen configuration.

-   If `LOAD_FROM_FILE` is `True`, it uses the `load_params_and_create_testenv` utility to parse the results and `.bat` files and construct the precise environment used during optimization.
-   If `False`, it builds the environment using the manual settings. For manual mode, it uses a default set of un-optimized reflex parameters (`np.ones(...)`).

After initialization, a summary of the active configuration is printed.

```python
if LOAD_FROM_FILE:
    # ... loads from file ...
    env, config, _ = load_params_and_create_testenv(...)
    print_config_summary(config, title="Loaded Configuration")
    
else:
    # ... uses manual settings ...
    env = myoLeg_reflex(...)
    print_config_summary(config, title="Manual Configuration")

env.reset()
```
For sloped terrains, a helper function `standardize_terrain_dimensions` is called to ensure the visual ground plane correctly aligns with the physical one.

## Simulation and Rendering

The final cell runs the simulation and records the video.

1.  **Setup**: It resets the environment and sets up a "free camera" that is programmed to track the model's movement along the x-axis.
2.  **Main Loop**: The script iterates through the number of timesteps corresponding to `SIMULATION_TIME`. In each step, it:
    a. Updates the camera's position to follow the pelvis of the model.
    b. Renders the current view to a frame using `env.env.sim.renderer.render_offscreen`.
    c. Executes a single step of the reflex controller and physics simulation using `env.run_reflex_step_Cost()`.
    d. Checks if the simulation has ended prematurely (e.g., if the model has fallen).
3.  **Video Encoding**: Once the loop completes, it uses the `imageio` library to compile the collected frames into an `simulation.mp4` video file, encoded at 100 FPS.

## Viewing the Output

-   All outputs are saved to a new, timestamped subfolder within `sample_run_output/`.
-   The path to the saved video is printed upon completion.
-   Finally, the notebook uses a helper function to display the video directly within the Jupyter interface. 